@inherits LayoutComponentBase
@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Localization
@using Microsoft.Extensions.Options
@using System.Globalization
@using FluentUiDemo.Localization
@using Volo.Abp.Localization
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IOptions<AbpLocalizationOptions> LocalizationOptions
@inject IStringLocalizer<FluentUiDemoResource> L

<FluentToastProvider />
<FluentDialogProvider />
<FluentTooltipProvider />

<FluentLayout>
    <FluentHeader>
        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Left"
                     VerticalAlignment="VerticalAlignment.Center" Style="width: 100%;">
            <FluentButton Appearance="Appearance.Stealth" OnClick="@ToggleNavMenu"
                          IconStart="@(new Icons.Regular.Size24.Navigation())" />
            <FluentLabel Typo="Typography.H5" Style="margin-left: 12px; color: white;">@L["AppName"]</FluentLabel>
            <FluentSpacer />
            <FluentSelect TOption="LanguageInfo"
                          Items="@_languages"
                          SelectedOption="@_selectedLanguage"
                          SelectedOptionChanged="@OnLanguageChanged"
                          OptionText="@(l => l.DisplayName)"
                          OptionValue="@(l => l.CultureName)"
                          OptionSelected="@(l => l.CultureName == _selectedLanguage?.CultureName)"
                          Width="140px"
                          Style="min-width: 140px; --neutral-fill-input-rest: rgba(255,255,255,0.1); --neutral-foreground-rest: white; color: white;" />
            <AuthorizeView>
                <Authorized>
                    <FluentLabel Style="color: white; margin-right: 8px;">@context.User.Identity?.Name</FluentLabel>
                    <FluentAnchor Href="/Account/Logout" Appearance="Appearance.Stealth">
                        <FluentIcon Value="@(new Icons.Regular.Size20.SignOut())" Color="Color.Fill" />
                    </FluentAnchor>
                </Authorized>
                <NotAuthorized>
                    <FluentAnchor Href="/Account/Login" Appearance="Appearance.Accent">@L["Login"]</FluentAnchor>
                </NotAuthorized>
            </AuthorizeView>
        </FluentStack>
    </FluentHeader>
    <FluentStack Orientation="Orientation.Horizontal" Style="height: calc(100vh - 50px); width: 100%;">
        @if (_navMenuExpanded)
        {
            <FluentNavMenu Width="250" Collapsible="true" @bind-Expanded="_navMenuExpanded"
                           Style="height: 100%; border-right: 1px solid var(--neutral-stroke-divider-rest);">
                <NavMenu />
            </FluentNavMenu>
        }
        <FluentBodyContent Style="padding: 24px; overflow-y: auto; flex: 1;">
            @Body
        </FluentBodyContent>
    </FluentStack>
</FluentLayout>

@code {
    private bool _navMenuExpanded = true;
    private List<LanguageInfo> _languages = new();
    private LanguageInfo? _selectedLanguage;

    protected override void OnInitialized()
    {
        _languages = LocalizationOptions.Value.Languages.ToList();
        _selectedLanguage = _languages.FirstOrDefault(l => l.CultureName == CultureInfo.CurrentCulture.Name)
                            ?? _languages.FirstOrDefault();
    }

    private void ToggleNavMenu()
    {
        _navMenuExpanded = !_navMenuExpanded;
    }

    private void OnLanguageChanged(LanguageInfo? language)
    {
        if (language == null || language.CultureName == CultureInfo.CurrentCulture.Name)
            return;

        _selectedLanguage = language;
        var uri = new Uri(NavigationManager.Uri)
            .GetComponents(UriComponents.PathAndQuery, UriFormat.Unescaped);
        var cultureEscaped = Uri.EscapeDataString(language.CultureName);
        var uriEscaped = Uri.EscapeDataString(uri);
        NavigationManager.NavigateTo(
            $"/culture/switch?culture={cultureEscaped}&returnUrl={uriEscaped}",
            forceLoad: true);
    }

}
